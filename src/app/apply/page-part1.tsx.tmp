'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'
import { parseResume, extractResumeData } from '@/lib/resumeParser'
import { loadSchoolsList } from '@/lib/mlhSchools'
import {
  LEVEL_OF_STUDY_OPTIONS,
  DIETARY_RESTRICTIONS_OPTIONS,
  GENDER_OPTIONS,
  PRONOUNS_OPTIONS,
  RACE_ETHNICITY_OPTIONS,
  SEXUAL_ORIENTATION_OPTIONS,
  EDUCATION_LEVEL_OPTIONS,
  TSHIRT_SIZES,
  MAJOR_OPTIONS,
  UNDERREPRESENTED_GROUP_OPTIONS,
  COUNTRIES,
  AGE_OPTIONS,
  US_STATES,
} from '@/lib/mlhConstants'

export default function ApplyPage() {
  const router = useRouter()
  const supabase = createClient()
  const [loading, setLoading] = useState(false)
  const [uploading, setUploading] = useState(false)
  const [error, setError] = useState('')
  const [user, setUser] = useState<any>(null)
  const [schools, setSchools] = useState<string[]>([])
  const [schoolSearch, setSchoolSearch] = useState('')

  const [formData, setFormData] = useState({
    // MLH Required Fields
    first_name: '',
    last_name: '',
    age: '',
    phone_number: '',
    email: '',
    school: '',
    level_of_study: 'Undergraduate University (3+ year)',
    country_of_residence: 'United States',
    
    // Professional Links
    linkedin_url: '',
    github_url: '',
    portfolio_url: '',
    
    // Resume
    resume_url: '',
    resume_markdown: '',
    
    // MLH Required Checkboxes
    mlh_code_of_conduct: false,
    mlh_privacy_policy: false,
    mlh_marketing_emails: false,
    
    // Optional Demographic Fields
    dietary_restrictions: [] as string[],
    underrepresented_group: '',
    gender: '',
    pronouns: '',
    race_ethnicity: [] as string[],
    sexual_orientation: '',
    education_level: '',
    tshirt_size: 'M',
    
    // Shipping Address
    address_line1: '',
    address_line2: '',
    city: '',
    state: '',
    shipping_country: 'United States',
    postal_code: '',
    
    // Major
    major: '',
    
    // Hackathon Specific
    first_hackathon: false,
    team_name: '',
    special_accommodations: '',
  })

  useEffect(() => {
    async function loadUser() {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        router.push('/login?redirect=/apply')
        return
      }
      setUser(user)
      setFormData(prev => ({ ...prev, email: user.email || '' }))

      // Check if user already has an application
      const { data: existingApp } = await supabase
        .from('applicants')
        .select('*')
        .eq('user_id', user.id)
        .single()

      if (existingApp) {
        // Pre-fill form with existing data
        setFormData({
          ...existingApp,
          dietary_restrictions: existingApp.dietary_restrictions || [],
          race_ethnicity: existingApp.race_ethnicity || [],
        })
      }
    }

    async function loadSchools() {
      const schoolsList = await loadSchoolsList()
      setSchools(schoolsList)
    }

    loadUser()
    loadSchools()
  }, [])

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
    const { name, value, type } = e.target
    const checked = (e.target as HTMLInputElement).checked

    setFormData(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }))
  }

  const handleMultiSelectChange = (field: 'dietary_restrictions' | 'race_ethnicity', value: string) => {
    setFormData(prev => {
      const currentValues = prev[field] as string[]
      const newValues = currentValues.includes(value)
        ? currentValues.filter(v => v !== value)
        : [...currentValues, value]
      return { ...prev, [field]: newValues }
    })
  }

  const handleResumeUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']
    if (!validTypes.includes(file.type)) {
      setError('Please upload a PDF or DOCX file')
      return
    }

    if (file.size > 5 * 1024 * 1024) {
      setError('File size must be less than 5MB')
      return
    }

    setUploading(true)
    setError('')

    try {
      const fileExt = file.name.split('.').pop()
      const fileName = `${user.id}_${Date.now()}.${fileExt}`
      const filePath = `resumes/${fileName}`

      const { error: uploadError } = await supabase.storage
        .from('applicant-files')
        .upload(filePath, file)

      if (uploadError) throw uploadError

      const { data: { publicUrl } } = supabase.storage
        .from('applicant-files')
        .getPublicUrl(filePath)

      const markdown = await parseResume(file)
      const extractedData = extractResumeData(markdown)

      setFormData(prev => ({
        ...prev,
        resume_url: publicUrl,
        resume_markdown: markdown,
        github_url: prev.github_url || extractedData.github || '',
        linkedin_url: prev.linkedin_url || extractedData.linkedin || '',
        phone_number: prev.phone_number || extractedData.phone || '',
      }))

    } catch (err: any) {
      console.error('Error uploading resume:', err)
      setError(err.message || 'Failed to upload resume')
    } finally {
      setUploading(false)
    }
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    setError('')

    // Validate MLH required checkboxes
    if (!formData.mlh_code_of_conduct || !formData.mlh_privacy_policy) {
      setError('You must agree to the MLH Code of Conduct and Privacy Policy to apply.')
      setLoading(false)
      return
    }

    try {
      const applicationData = {
        ...formData,
        user_id: user.id,
        age: parseInt(formData.age),
      }

      const { data: existing } = await supabase
        .from('applicants')
        .select('id')
        .eq('user_id', user.id)
        .single()

      if (existing) {
        const { error: updateError } = await supabase
          .from('applicants')
          .update(applicationData)
          .eq('user_id', user.id)

        if (updateError) throw updateError
      } else {
        const { error: insertError } = await supabase
          .from('applicants')
          .insert([applicationData])

        if (insertError) throw insertError
      }

      router.push('/dashboard')
    } catch (err: any) {
      console.error('Error submitting application:', err)
      setError(err.message || 'Failed to submit application')
    } finally {
      setLoading(false)
    }
  }

  const filteredSchools = schools.filter(school =>
    school.toLowerCase().includes(schoolSearch.toLowerCase())
  ).slice(0, 100)

  if (!user) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#030c1b] via-[#0a1628] to-[#030c1b]">
        <div className="text-white">Loading...</div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#030c1b] via-[#0a1628] to-[#030c1b] py-12 px-4">
      <div className="max-w-4xl mx-auto">
        <div className="bg-white/5 backdrop-blur-lg rounded-2xl border border-white/10 p-8">
          <h1 className="text-4xl font-bold text-white mb-2">Apply to RocketHacks 2026</h1>
          <p className="text-gray-400 mb-8">Complete your application to join us at the biggest hackathon in the Midwest!</p>

          {error && (
            <div className="bg-red-500/10 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg mb-6">
              {error}
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-8">
            {/* MLH Partnership Notice */}
            <div className="bg-blue-500/10 border border-blue-500/50 text-blue-300 px-4 py-3 rounded-lg text-sm">
              <strong>MLH Partnership Notice:</strong> We are currently in the process of partnering with MLH. 
              The following checkboxes are for this partnership. If we do not end up partnering with MLH, your information will not be shared.
            </div>

            {/* Required Personal Information */}
            <section>
              <h2 className="text-2xl font-semibold text-white mb-4">Personal Information *</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    First Name *
                  </label>
                  <input
                    type="text"
                    name="first_name"
                    required
                    value={formData.first_name}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Maria Anne"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    Last Name *
                  </label>
                  <input
                    type="text"
                    name="last_name"
                    required
                    value={formData.last_name}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="De La Cruz"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    Age *
                  </label>
                  <select
                    name="age"
                    required
                    value={formData.age}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">Select your age</option>
                    {AGE_OPTIONS.map(age => (
                      <option key={age} value={age}>{age}</option>
                    ))}
                  </select>
                  <p className="text-xs text-gray-500 mt-1">Required for eligibility (some sponsors require 18+)</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    Phone Number *
                  </label>
                  <input
                    type="tel"
                    name="phone_number"
                    required
                    value={formData.phone_number}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="+1 (555) 123-4567"
                  />
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    Email *
                  </label>
                  <input
                    type="email"
                    name="email"
                    required
                    value={formData.email}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="your.email@example.com"
                    disabled
                  />
                </div>
              </div>
            </section>

            {/* Educational Information */}
            <section>
              <h2 className="text-2xl font-semibold text-white mb-4">Educational Information *</h2>
              <div className="grid grid-cols-1 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    School/University * (Search from MLH verified list)
                  </label>
                  <input
                    type="text"
                    value={schoolSearch}
                    onChange={(e) => setSchoolSearch(e.target.value)}
                    placeholder="Start typing to search..."
                    className="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2"
                  />
                  <select
                    name="school"
                    required
                    value={formData.school}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 max-h-40"
                    size={5}
                  >
                    <option value="">Select your school</option>
                    {filteredSchools.map(school => (
                      <option key={school} value={school}>{school}</option>
                    ))}
                  </select>
                  <p className="text-xs text-gray-500 mt-1">Can't find your school? Contact us to add it.</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    Level of Study *
                  </label>
                  <select
                    name="level_of_study"
                    required
                    value={formData.level_of_study}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    {LEVEL_OF_STUDY_OPTIONS.map(option => (
                      <option key={option} value={option}>{option}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    Country of Residence *
                  </label>
                  <select
                    name="country_of_residence"
                    required
                    value={formData.country_of_residence}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    {COUNTRIES.map(country => (
                      <option key={country} value={country}>{country}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    Major/Field of Study
                  </label>
                  <select
                    name="major"
                    value={formData.major}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">Select your major</option>
                    {MAJOR_OPTIONS.map(option => (
                      <option key={option} value={option}>{option}</option>
                    ))}
                  </select>
                </div>
              </div>
            </section>

            {/* To be continued in next file due to length... */}
          </form>
        </div>
      </div>
    </div>
  )
}
